#!name=Zymk 解锁+去广告（内嵌版）
#!desc=知音漫客去广告 + 解锁会员与付费章节（单文件版）
#!author=夜日定制
#!category=Unlock, Remove Ads

[MITM]
hostname = *.kaimanhua.com, *.zymk.cn

[URL Rewrite]
^https?:\/\/(api|api-cdn|apigate)\.(kaimanhua|zymk)\.(com|cn)\/advertise.* - reject

[Script]
# > 知音漫客 解锁会员与付费章节
http-response ^https?:\/\/(api|api-cdn|apigate)\.(kaimanhua|zymk)\.(com|cn)\/.*(getuserinfo|user\/v\d+\/info|paychapters|chapterAuth|chapter\/auth).* requires-body=true, timeout=10, script-type=javascript, tag=Zymk_Unlock, script-content="""
const url = $request.url;
let body = $response.body;

try {
  let obj = JSON.parse(body);
  if (/getuserinfo|user\/v\d+\/info/.test(url)) {
    obj.data.vip = 1;
    obj.data.isvip = 1;
    obj.data.end_time = "2099-12-31";
  }

  if (/paychapters|chapterAuth|chapter\/auth/.test(url)) {
    if (obj.data) {
      obj.data.is_buy = 1;
      obj.data.chapter_price = 0;
    }
  }
  $done({ body: JSON.stringify(obj) });
} catch (e) {
  console.log("Zymk unlock error:", e);
  $done({});
}
"""
